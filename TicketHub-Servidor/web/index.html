<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TicketHub - Login</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            /*upgrade*/
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1f2121 0%, #2a3a40 100%);
            min-height: 100vh; display: flex;
            justify-content: center;  align-items: center;
        }

        .login-container {
            background: white; padding: 40px; /*upgrade*/
            border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            width: 100%;  max-width: 400px;  margin: 20px;
        }

        /*upgrade para reduir tama√±o */
        .login-container h1 { color: #208090; margin-bottom: 10px; font-size: 32px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button {
            width: 100%; padding: 12px; background-color: #208090; color: white;
            border: none; border-radius: 4px; font-size: 16px; cursor: pointer;
            transition: 0.3s;
        }
        button:hover { background-color: #186b7b; }
        .error { color: #f44336; margin-top: 10px; font-size: 14px; }

        /*upgrade nuevamente para reducir tama√±o*/
        .dashboard { display: none; width: 100%; height: 100vh; flex-direction: column; }
        .header {
            background-color: #1f2121; color: white; padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .container { display: flex; flex: 1; overflow: hidden; }

        /*upgrade nuevamente para lo mismo, esto principalmente lo hago*/
        /*upgrade para reducir el tama√±o en la documentacion y para */
        /*upgrade mejorar visiblemente la vista */
        .sidebar {
            width: 220px; background-color: #f0f2f5; padding: 20px;
            display: flex; flex-direction: column; gap: 10px;
            border-right: 1px solid #ddd;
        }
        .sidebar button {
            background-color: white; color: #333; border: 1px solid #ddd;
            text-align: left; padding: 12px; font-size: 14px;
        }
        .sidebar button:hover { background-color: #e9ecef; border-color: #208090; color: #208090; }
        .sidebar button.active { background-color: #208090; color: white; border-color: #208090; }

        /*upgrade: algo nuevo para el superadmin*/
        /* Boton especial ADMIN */
        #btnAdmin {
            background-color: #2c3e50; color: #f1c40f; border: 1px solid #f1c40f;
            display: none; /* Oculto por defecto */
        }
        #btnAdmin:hover { background-color: #34495e; }        
        
        /*upgrade*/
        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background-color: #f8f9fa; }
        .tabla-container {
            background: white; border-radius: 8px; overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background-color: #2c3e50; color: white; padding: 15px; text-align: left; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background-color: #f8f9fa; }

        /*upgrade Aqui agregamos nuevos campos para la tabla prioridad*/
        /*upgrade y se les cambio la sintaxis*/
        /* ESTADOS Y PRIORIDADES */
        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; }
        
        .st-espera { background-color: #78909c; color: white; } /* Gris azulado */
        .st-proceso { background-color: #ff9800; color: #212121; } /* Naranja */
        .st-cerrado { background-color: #4caf50; color: #003300; } /* Verde - Ojo, cambie cerrado a verde (exito) */

        .pr-baja { background-color: #81c784; color: #1b5e20; }
        .pr-media { background-color: #ffb74d; color: #e65100; }
        .pr-alta { background-color: #e57373; color: #b71c1c; }

        
        /*upgrade Esto es lo antes mencionado se le agregaron finciones nuevas a la tabla*/
        /* BOTONES DE ACCION EN TABLA */
        .acciones { display: flex; flex-direction: column; gap: 4px; }
        .grupo-botones { display: flex; gap: 2px; }
        .btn-mini {
            padding: 4px; font-size: 10px; border-radius: 2px; border: none;
            cursor: pointer; color: white; flex: 1;
        }
        .btn-azul { background-color: #2196f3; }
        .btn-naranja { background-color: #ff9800; }
        .btn-verde { background-color: #4caf50; }
        .btn-gris { background-color: #607d8b; }
        
        .mensaje { padding: 10px; margin-bottom: 15px; border-radius: 4px; display: none; text-align: center;}
        .mensaje.exito { background-color: #d4edda; color: #155724; }
        .mensaje.error { background-color: #f8d7da; color: #721c24; }

        /*upgrade: lo nuevo solo para el superadmin antes mencionado*/
        /* VISTA ADMIN */
        #adminPanel { display: none; }
        .admin-card {
            background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;
            border-left: 5px solid #f1c40f;
        }
            

        html {
            font-size: 14px;
        }

        @media (max-width: 600px) {
            html {
                font-size: 12px;
            }
        }

        /*upgrade: A partir de aqui inician las reglas responsivas*/    
        @media (max-width: 480px) {
            .header     { flex-direction: column; text-align: center; padding: 10px;}
            .header h1  { font-size: 1.2rem; }
            .user-info  { text-align: center; width: 100%; }
            .logout-btn { width: 100%; }
            .container  { flex-direction: column; }
            .sidebar    {width: 100% !important; flex-direction: row; min-height: auto;}
            .main-content {  padding: 10px; }

            table { font-size: 0.75rem; }
            th, td {  padding: 6px; }

            .acciones button { font-size: 0.65rem; padding: 4px 6px; }
            .estado { font-size: 0.65rem; padding: 2px 4px;}
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .sidebar { width: 100% !important; flex-direction: row; min-height: auto; }
            .container { flex-direction: column; }
            table { font-size: 0.8rem; }
            th, td { padding: 8px; }
            .main-content { padding: 12px; }
        }

        @media (min-width: 769px) {
            table {font-size: 0.9rem; }
            th, td { padding: 12px; }
            .main-content { padding: 20px; }
        }
    </style>
</head>
<body>

<!-- PANTALLA DE LOGIN -->
<div id="loginScreen" class="login-container">
    <h1>TicketHub</h1>
    <p>Acceso al Sistema</p>
    <form id="loginForm">
        <div class="form-group">
            <label>Usuario</label>
            <input type="text" id="usuario" required placeholder="Ej: raul">
        </div>
        <div class="form-group">
            <label>Contrase√±a</label>
            <input type="password" id="contrasena" required>
        </div>
        <button type="submit">Iniciar Sesion</button>
        <div id="loginError" class="error"></div>
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #999;">
            <strong>Demo:</strong><br>
            juan / 1234<br>
            maria / 1234<br>
            carlos / 1234
        </div>
    </form>
</div>

<!-- PANTALLA DEL DASHBOARD -->
<div id="dashboard" class="dashboard">
    <div class="header">
        <h1>TicketHub <span style="font-size: 14px; opacity: 0.6;">v2.0</span></h1>
        <div class="user-info">
            <p id="tecnicoNombre">Tecnico: --</p>
            <p id="tecnicoEspecialidad">Especialidad: --</p>
            <a href="#" onclick="logout()" style="color: #ff8a80; font-size: 12px;">Cerrar Sesion</a>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <button onclick="cambiarVista('todos')" class="active" id="navTodos">‚ñ∫ Todos los Tickets</button>
            <button onclick="cambiarVista('mios')" id="navMios">‚ñ∫ Mis Tickets</button>
            <button onclick="mostrarNuevoTicket()">(Nuevo Ticket</button>
            
            <button onclick="cambiarVista('admin')" id="btnAdmin">‚òªÔ∏è Super Admin</button>
        </div>

        <div class="main-content">
            <div id="mensaje" class="mensaje"></div>
            
            <div id="vistaTickets">
                <h2 id="tituloSeccion">Tablero de Control</h2>
                <div class="tabla-container">
                    <table>
                        <thead>
                            <tr>
                                <th width="5%">ID</th>
                                <th width="25%">Titulo</th>
                                <th width="10%">Estado</th>
                                <th width="10%">Prioridad</th>
                                <th width="15%">Tecnico</th>
                                <th width="15%">Fecha</th>
                                <th width="20%">Gestionar</th>
                        </tr>
                    </thead>
                    <tbody id="ticketsBody">
                        <tr>
                            <td colspan="7" style="text-align: center; color: #999;">Cargando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            </div>

            <!--upgrade: se hicieron cambios en esa seccion para poder agregar desde este panel 
                como ya se comentaba antes  -->
            <div id="adminPanel">
                <h2>üõ°Ô∏è Panel de Super Administrador</h2>
                
                <div class="admin-card">
                    <h3>üë§ Registrar Nuevo T√©cnico</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label>Nombre Completo:</label>
                            <input type="text" id="newNombre" placeholder="Ej: Anais Quijano">
                        </div>
                        <div>
                            <label>Especialidad:</label>
                            <input type="text" id="newEsp" placeholder="Ej: Redes">
                        </div>
                        <div>
                            <label>Usuario Login:</label>
                            <input type="text" id="newUser" placeholder="Ej: anais">
                        </div>
                        <div>
                            <label>Contrase√±a:</label>
                            <input type="password" id="newPass" placeholder="*****">
                        </div>
                    </div>
                    <button onclick="crearTecnico()" style="margin-top:15px; width:auto;">üíæ Guardar T√©cnico</button>
                </div>

                <div class="admin-card">
                    <h3>Resumen del Sistema</h3>
                     <button onclick="alert('Limpieza realizada')" style="width: auto; background: #e74c3c;">üóëÔ∏è Limpiar Logs</button>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // Detectar automaticamente la URL del servidor
    const API_URL = window.location.protocol + '//' + window.location.hostname + ':' + window.location.port;
    let tecnicoActual = null;
    let vistaActual = 'todos';
    // Variable global para guardar la lista de tecnicos
    let listaTecnicos = [];

    // LOGIN
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const usuario = document.getElementById('usuario').value;
        const contrasena = document.getElementById('contrasena').value;

        try {
            const res = await fetch(API_URL + '/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usuario, contrasena })
            });

            const data = await res.json();

            if (data.ok) {
                tecnicoActual = {
                    id: data.id_tecnico,             nombre: data.nombre,
                    especialidad: data.especialidad, user: usuario };
                /*upgrade vamos a cambiar un poco la funcion de cargar tickets para despues*/
                iniciarSesion();
            } else {
                document.getElementById('loginError').textContent = data.msg;
            }
        } catch(e) { console.error(e); }
    });
    
    /*upgrade: nueva funcion para hacer servir al superadmin, en DAW se manejaba*/
    /*upgrade: diferente con los session*/
    
    function iniciarSesion() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'flex'; // Flex para layout
        document.getElementById('tecnicoNombre').textContent = tecnicoActual.nombre;
        document.getElementById('tecnicoEspecialidad').textContent = tecnicoActual.especialidad;

        // VERIFICACION DE SUPER ADMIN
        if (tecnicoActual.user === 'raul') {
            document.getElementById('btnAdmin').style.display = 'block';
        }

        cargarTickets();
        setInterval(cargarTickets, 7000); // Auto refresh
    }

    // --- NAVEGACION ---
    function cambiarVista(vista) {
        vistaActual = vista;
        
        // Reset botones sidebar
        document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
        
        if (vista === 'admin') {
            document.getElementById('btnAdmin').classList.add('active');
            document.getElementById('vistaTickets').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
        } else {
            document.getElementById('vistaTickets').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            if (vista === 'todos') document.getElementById('navTodos').classList.add('active');
            if (vista === 'mios') document.getElementById('navMios').classList.add('active');
            cargarTickets();
        }
    }
    
    /*upgrade: */
    async function cargarListaTecnicos() {
        try {
            const res = await fetch(API_URL + '/tecnicos');
            const data = await res.json();
            if(data.ok) listaTecnicos = data.tecnicos;
        } catch(e) { console.error(e); }
    }
    
    // CARGAR TICKETS
    async function cargarTickets() {
        if (vistaActual === 'admin') return;
        
        // Primero aseguramos tener la lista de tecnicos actualizada
        if(listaTecnicos.length === 0) await cargarListaTecnicos();
        
        try {
            const res = await fetch(API_URL + '/tickets');
            const data = await res.json();
            const tbody = document.getElementById('ticketsBody') || document.getElementById('tickets');
            tbody.innerHTML = '';
            let tickets = data.tickets;
            
            if (vistaActual === 'mios') {
                tickets = tickets.filter(t => t.id_tecnico === tecnicoActual.id);
                document.getElementById('tituloSeccion').textContent = 'Mis Tickets Asignados';
            } else {
                document.getElementById('tituloSeccion').textContent = 'Tablero de Control - Todos';
            }

            if (tickets.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#999; padding:20px;">No hay tickets disponibles</td></tr>';
            return;
        }
                /*upgrade:*/
                tickets.forEach(t => {
                    let stClass = 'st-espera';
                    if (t.estado === 'EN_PROCESO') stClass = 'st-proceso';
                    if (t.estado === 'CERRADO') stClass = 'st-cerrado';
                    
                    let prClass = 'pr-baja';
                    if (t.prioridad === 'Media' || t.prioridad === 'MEDIA') prClass = 'pr-media';
                    if (t.prioridad === 'Alta' || t.prioridad === 'ALTA') prClass = 'pr-alta';
                    
                    // Nombre tecnico
                    let tecName = '<span style="color:#999;">-- Libre --</span>';
                    if (t.id_tecnico) tecName = (t.id_tecnico === tecnicoActual.id) ? '<strong>(YO)</strong>' : `Tec. #${t.id_tecnico}`;

                    /*upgrade*/
                    let controles = '';
                    // Si es admin (raul por el momento) o el ticket es mio o esta libre, puedo tocarlo
                    const tengoPermiso = (tecnicoActual.user === 'raul' || t.id_tecnico === tecnicoActual.id || t.id_tecnico === null);

                    if (tengoPermiso) {
                        /*upgrade: nueva logica para la asigancion*/
                        let bloqueAsignar = '';
                    // Si soy Admin o el ticket esta libre, muestro el selector
                    if (tecnicoActual.user === 'raul' || !t.id_tecnico) {
                        // Creamos el dropdown con los tecnicos
                        let opciones = listaTecnicos.map(tec => 
                            `<option value="${tec.id}">${tec.nombre}</option>`
                        ).join('');
                        
                        bloqueAsignar = `
                            <div style="display:flex; gap:2px; margin-bottom:4px;">
                                <select id="sel-${t.id}" style="font-size:10px; width: 80px;">
                                    <option value="${tecnicoActual.id}">A m√≠</option>
                                    ${opciones}
                                </select>
                                <button class="btn-mini btn-azul" onclick="asignarSeleccionado(${t.id})">Ir</button>
                            </div>
                        `;
                    }
                        //upgrade: Botones Estado (Siempre visibles para cambiar cuando quieras)
                        let btnsEstado = `
                            <div class="grupo-botones" style="margin-top:2px;">
                                <button class="btn-mini btn-gris" onclick="cambiarEstado(${t.id}, 'EN_ESPERA')" title="Poner en Espera">‚è≥</button>
                                <button class="btn-mini btn-naranja" onclick="cambiarEstado(${t.id}, 'EN_PROCESO')" title="Trabajar">üî®</button>
                                <button class="btn-mini btn-verde" onclick="cambiarEstado(${t.id}, 'CERRADO')" title="Finalizar">‚úÖ</button>
                            </div>
                        `;

                    //upgrade: Botones Prioridad para poder hacer los cambios de lo que se a agregado
                    let btnsPrioridad = `
                        <div class="grupo-botones" style="margin-top:4px;">
                            <button class="btn-mini pr-baja" onclick="cambiarPrioridad(${t.id}, 'BAJA')">‚ÆØbaja</button>
                            <button class="btn-mini pr-media" onclick="cambiarPrioridad(${t.id}, 'MEDIA')">‚û•media</button>
                            <button class="btn-mini pr-alta" onclick="cambiarPrioridad(${t.id}, 'ALTA')">‚Æ≠alta</button>
                        </div>
                    `;

                    controles = `<div class="acciones">${bloqueAsignar} ${btnsEstado} ${btnsPrioridad}</div>`;
                } else {
                    controles = '<small style="color:#999;">X Bloqueado X</small>';
                }

                    const row = `
                    <tr>
                        <td><b>#${t.id}</b></td>
                        <td>${t.titulo}</td>
                        <td><span class="badge ${stClass}">${t.estado || 'EN_ESPERA'}</span></td>
                        <td><span class="badge ${prClass}">${t.prioridad || 'BAJA'}</span></td>
                        <td>${tecName}</td>
                        <td style="font-size:11px;">${t.creado_en}</td>
                        <td>${controles}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

        } catch(e) { 
            console.error("Error dibujando tabla:", e); // Esto saldr√° en F12 si falla algo}
    }
}

    /*
     * 
     * @param {type} id
     * @returns {undefined}
     * 
     * Faltan muchas modificaciones a estas funciones siguientes, pero por
     * el momento asi lo dejamos para poder continuar en otro momento
     * 
     * -Cambiar asignarse pora que pueda ser util tambien con superadmin y 
     * sepa el id_tecnico atual y hacerlo mas sencillo para 
     * 
     * 
     */
    
    
    
// ASIGNARSE A UN TICKET
    /* upgrade: ACCIONES DE API*/

async function asignarSeleccionado(idTicket) {
        // Obtenemos el ID del tecnico seleccionado en el dropdown especifico de este ticket
        const select = document.getElementById('sel-' + idTicket);
        const idTecnico = select.value;
        
        await fetchAPI(`/tickets/${idTicket}/asignar`, 'PUT', { id_tecnico: parseInt(idTecnico) });
        notificar('Ticket reasignado correctamente', 'exito');
    }

    async function crearTecnico() {
        const nombre = document.getElementById('newNombre').value;
        const esp = document.getElementById('newEsp').value;
        const user = document.getElementById('newUser').value;
        const pass = document.getElementById('newPass').value;

        if(!nombre || !user || !pass) return alert("Faltan datos");

        try {
            const res = await fetch(API_URL + '/tecnicos', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ nombre, especialidad: esp, usuario: user, contrasena: pass })
            });
            const data = await res.json();
            
            if(data.ok) {
                notificar('Tecnico registrado con exito', 'exito');
                // Limpiar form
                document.getElementById('newNombre').value = '';
                document.getElementById('newUser').value = '';
                document.getElementById('newPass').value = '';
                cargarListaTecnicos(); // Recargar lista para que salga en los dropdowns
            } else {
                alert("Error al crear: " + data.msg);
            }
        } catch(e) { console.error(e); }
    }


    async function cambiarEstado(id, estado) {
        await fetchAPI(`/tickets/${id}/estado`, 'PUT', { estado: estado });
        notificar(`Estado cambiado a ${estado}`, 'exito');
    }

    async function cambiarPrioridad(id, prioridad) {
        await fetchAPI(`/tickets/${id}/prioridad`, 'PUT', { prioridad: prioridad });
        notificar(`Prioridad cambiada a ${prioridad}`, 'exito');
    }

    async function mostrarNuevoTicket() {
        const titulo = prompt("Titulo del problema:");
        if(!titulo) return;
        const desc = prompt("Descripcion adicional:");
        
        await fetchAPI('/tickets', 'POST', {
            titulo: titulo, 
            descripcion: desc || "",
            id_cliente: null,
            id_categoria: null
        });
        notificar('Ticket creado en estado EN_ESPERA', 'exito');
    }

    // Funcion generica para fetch
    async function fetchAPI(endpoint, method, body) {
        try {
            await fetch(API_URL + endpoint, {
                method: method,
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(body)
            });
            // Si el servidor nos dice que hubo error (ej: 400 o 500)
            if (!res.ok) {
                const errorData = await res.json();
                console.error("Error API:", errorData); // Ver en consola con F12
                notificar('Error del servidor: ' + (errorData.msg || res.statusText), 'error');
                return; // Detenemos aqui para no recargar en falso
            }

            // Si todo salio bien
            cargarTickets(); 
            
        } catch(e) {
            console.error(e);
            notificar('Error de conexion (Revisa la consola con F12)', 'error');
        }
    }

    function notificar(msg, tipo) {
        const div = document.getElementById('mensaje');
        div.textContent = msg;
        div.className = 'mensaje ' + tipo;
        div.style.display = 'block';
        setTimeout(() => div.style.display = 'none', 3000);
    }

    function logout() {
        location.reload(); // Manera mas facil de limpiar todo
    }
</script>

</body>
</html>
